<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calibration Curve | MR Pharma Tools</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family:"Times New Roman", Times, serif; margin:0; background:#fff; }
header { background:#1f3c88; color:white; padding:18px; text-align:center; }
nav { background:#102654; padding:10px; text-align:center; }
nav a { color:white; margin:0 10px; text-decoration:none; padding:8px 14px; border-radius:4px; }
nav a:hover { background:#1f3c88; }
main { max-width:1200px; margin:30px auto; padding:20px; }
.section { background:#f7f9fd; padding:25px; border-radius:6px; box-shadow:0 4px 10px rgba(0,0,0,0.06); }
.flex { display:flex; gap:30px; flex-wrap:wrap; }
.flex > div { flex:1; min-width:300px; }
table { width:100%; border-collapse:collapse; margin-bottom:15px; }
th, td { border:1px solid #ccc; padding:12px; text-align:center; }
th { background:#e8edfa; }
input { width:95%; padding:6px; margin:2px 0; font-family:"Times New Roman", Times, serif; box-sizing:border-box; }
button { background:#1f3c88; color:white; border:none; padding:10px 18px; cursor:pointer; border-radius:4px; margin:4px; }
button:hover { background:#162f66; }
.output-box { margin-top:20px; padding:15px; background:white; border-left:6px solid #1f3c88; font-size:1.05em; }
footer { background:#f0f3fa; text-align:center; padding:12px; color:#1f3c88; border-top:1px solid #ccc; }
</style>
</head>

<body>
<header>
<h1>MR Pharma Tools</h1>
<p>Calibration Curve Calculator</p>
</header>

<nav>
<a href="index.html">Home</a>
<a href="calibration-curve.html">Calibration Curve</a>
<a href="tablet_friability.html">Tablet % Friability</a>
<a href="f1-f2-calculator.html">F1–F2 Similarity</a>
</nav>

<main>
<div class="section flex">

<div>
<h2>Input Data</h2>
<table id="dataTable">
  <thead>
    <tr>
      <th>Concentration (µg/mL)</th>
      <th contenteditable="true">Absorbance 1 (nm)</th>
    </tr>
  </thead>
  <tbody>
    <tr><td><input></td><td><input></td></tr>
    <tr><td><input></td><td><input></td></tr>
    <tr><td><input></td><td><input></td></tr>
  </tbody>
</table>

<button onclick="addRow()">Add Concentration</button>
<button onclick="addAbsorbance()">Add Absorbance Column</button>
<button onclick="generateCurve()">Generate Calibration Curve</button>
<button onclick="exportToExcel()">Export to Excel</button>

<div class="output-box" id="resultBox"></div>
</div>

<div>
<canvas id="calibrationChart"></canvas>
</div>

</div>
</main>

<footer>© 2025 Mehul Rohit</footer>

<script>
let chart = null;

// Add a new row
function addRow() {
  let tbody = document.querySelector("#dataTable tbody");
  let cols = document.querySelectorAll("#dataTable thead th").length;
  let tr = document.createElement("tr");
  for(let i=0;i<cols;i++){
    let td = document.createElement("td");
    let inp = document.createElement("input");
    td.appendChild(inp);
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
}

// Add a new absorbance column
function addAbsorbance() {
  let thead = document.querySelector("#dataTable thead tr");
  let th = document.createElement("th");
  th.contentEditable = true;
  th.innerText = "Absorbance " + (thead.children.length);
  thead.appendChild(th);

  let rows = document.querySelectorAll("#dataTable tbody tr");
  rows.forEach(row => {
    let td = document.createElement("td");
    let inp = document.createElement("input");
    td.appendChild(inp);
    row.appendChild(td);
  });
}

// Generate calibration curve
function generateCurve() {
  let table = document.getElementById("dataTable");
  let header = table.querySelectorAll("thead th");
  let rows = table.querySelectorAll("tbody tr");

  let datasets = [];
  let equations = [];

  for(let col=1; col<header.length; col++){
    let x=[], y=[];
    for(let i=0;i<rows.length;i++){
      let conc = parseFloat(rows[i].cells[0].children[0].value);
      let abs = parseFloat(rows[i].cells[col].children[0].value);
      if(!isNaN(conc) && !isNaN(abs)){
        x.push(conc);
        y.push(abs);
      }
    }
    if(x.length<2) continue;

    // Linear regression
    let n=x.length, sumX=0,sumY=0,sumXY=0,sumX2=0;
    for(let i=0;i<n;i++){ sumX+=x[i]; sumY+=y[i]; sumXY+=x[i]*y[i]; sumX2+=x[i]*x[i]; }
    let slope=(n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
    let intercept=(sumY - slope*sumX)/n;
    let yPred = x.map(v=>slope*v + intercept);

    let meanY=sumY/n, ssTot=0, ssRes=0;
    for(let i=0;i<n;i++){ ssTot+=Math.pow(y[i]-meanY,2); ssRes+=Math.pow(y[i]-yPred[i],2);}
    let r2=1 - (ssRes/ssTot);

    equations.push(`<b>${header[col].innerText}:</b> y=${slope.toFixed(4)}x + ${intercept.toFixed(4)}, R²=${r2.toFixed(4)}`);

    datasets.push({
      label: header[col].innerText,
      data: x.map((v,i)=>({x:v, y:y[i]})),
      borderColor: getRandomColor(),
      backgroundColor: getRandomColor(),
      showLine:false
    });
    datasets.push({
      label: header[col].innerText + " regression",
      data: x.map((v,i)=>({x:v, y:yPred[i]})),
      borderColor: datasets[datasets.length-1].borderColor,
      backgroundColor: datasets[datasets.length-1].borderColor,
      type:'line',
      fill:false
    });
  }

  document.getElementById("resultBox").innerHTML = equations.join("<br>");

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("calibrationChart"), {
    type:'scatter',
    data:{datasets:datasets},
    options:{
      responsive:true,
      scales:{
        x:{title:{display:true,text:'Concentration (µg/mL)'}},
        y:{title:{display:true,text:'Absorbance (nm)'}}
      }
    }
  });
}

// Export table to Excel
function exportToExcel() {
    let table = document.getElementById("dataTable");
    let wb = XLSX.utils.book_new();
    let ws_data = [];

    // Header row
    let header = [];
    table.querySelectorAll("thead th").forEach(th => {
        header.push(th.innerText);
    });
    ws_data.push(header);

    // Data rows
    table.querySelectorAll("tbody tr").forEach(tr => {
        let row = [];
        tr.querySelectorAll("td input").forEach(inp => {
            row.push(inp.value || "");
        });
        ws_data.push(row);
    });

    let ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "CalibrationCurve");

    XLSX.writeFile(wb, "CalibrationCurve.xlsx");
}

// Random color for graph
function getRandomColor(){let letters='0123456789ABCDEF';let color='#';for(let i=0;i<6;i++){color+=letters[Math.floor(Math.random()*16)];}return color;}
</script>

</body>
</html>
